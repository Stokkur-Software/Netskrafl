
{% extends "container.html" %}

{% block opengraph %}

<meta property="og:locale" content="is_IS" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Netskrafl" />
<meta property="og:description" content="Spilaðu skrafl á netinu" />
<meta property="og:image" content="{{ url_for('static', filename='NetskraflFacebookImageSq.jpg', _external=True) | safe }}" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="600" />
<meta property="og:image:height" content="600" />

{% endblock %}

{% block startscripts %}
{% include 'firebase.html' %}
{% include 'firebase-auth.html' %}
{% endblock %}

{% block scripts %}
{% endblock %}

{% block logo %}
{% include 'logo.html' %}
{% endblock %}

{% block content %}

<div class="loginform-large">
   <!-- Large UI form -->
   <div class="loginhdr">
      Velkomin í Netskrafl!
   </div>
   <div class="blurb">
      Skemmtilegt | skerpandi | ókeypis
   </div>
   <div id="board-pic"><img src="{{ url_for('static', filename='Board.png') }}" width="310" height="300"></div>
   <div class="welcome">
      Netskrafl er vettvangur <b>yfir 16.000 íslenskra skraflara</b> á netinu.
   </div>
   <div class="welcome">
      Netskrafl notar Google Accounts innskráningu, þá
      sömu og er notuð m.a. í Gmail.
   </div>
   <div class="welcome">
      Netskrafl safnar hvorki persónuupplýsingum né geymir þær.
   </div>
   <div class="welcome">
      Þú getur alltaf
      fengið <a href="{{ url_for('help') }}">hjálp</a> með því að
      smella á <a href="{{ url_for('help') }}">bláa&nbsp;&nbsp;<span class="glyphicon glyphicon-info-sign"></span> - merkið</a>
      hér til vinstri.
   </div>
   <div style="float:right">
      <div id="firebaseui-auth-container" lang="is"></div>
   </div>
</div>

<div class="loginform-small">
   <!-- Small UI form -->
   <div id="logo-pic">
      <img src="{{ url_for('static', filename='LoginLogo600.png') }}" width="300" height="300">
   </div>
   <div class="blurb">
      Skemmtilegt | skerpandi | ókeypis
   </div>
   <div style="text-align: center">
      <div id="firebaseui-auth-container" lang="is"></div>
   </div>
</div>

{% endblock %}

{% block endscripts %}

<script>

function getCookie(name) {
   var v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
   return v ? v[2] : null;
}

var postIdTokenToSessionLogin = function(url, idToken, csrfToken) {
  // POST to session login endpoint
  return $.ajax({
    type:'POST',
    url: url,
    data: {idToken: idToken, csrfToken: csrfToken},
    contentType: 'application/x-www-form-urlencoded'
  });
};

function handleSignedInUser(user, initialUrl) {
   // Show redirection notice.
   // document.getElementById('redirecting').classList.remove('hidden');
   // Set session cookie
   user.getIdToken().then(function(idToken) {
      // Session login endpoint is queried and the session cookie is set.
      // CSRF token should be sent along with request.
      var csrfToken = getCookie('csrfToken')
      return postIdTokenToSessionLogin('/sessionLogin', idToken, csrfToken)
         .then(function() {
         // Redirect to initial URL on success
         window.location.assign(initialUrl);
      }, function(error) {
         // Refresh page on error.
         // In all cases, client side state should be lost due to in-memory
         // persistence.
         window.location.assign('/');
      });
   });
};

function showFirebaseLoginWidget(initialUrl) {
   var uiConfig = {
      'callbacks': {
         'signInSuccess': function(user, credential, redirectUrl) {
            // Called when the user has been successfully signed in
            // Handle signed in user
            handleSignedInUser(user, initialUrl);
            // Do not automatically redirect
            return false;
         },
         'uiShown': function() {
            // Remove progress bar when the UI is ready.
            // document.getElementById('loading').classList.add('hidden');
         }
      },
      // 'signInSuccessUrl': initialUrl,
      'signInOptions': [
         // Leave the lines as is for the providers you want to offer your users.
         firebase.auth.GoogleAuthProvider.PROVIDER_ID
      ],
      // Terms of service url
      // 'tosUrl': '<your-tos-url>',
   };
   var ui = new firebaseui.auth.AuthUI(firebase.auth());
   ui.start('#firebaseui-auth-container', uiConfig);
}

function initMain() {
   firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE);
   showFirebaseLoginWidget("{{ login_url }}");
}

$(document).ready(initMain);

</script>

{% endblock %}
